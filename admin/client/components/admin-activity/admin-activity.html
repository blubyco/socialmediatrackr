<div>
  <h4 ng-show="loading">
    <i class="fa fa-spinner fa-spin"></i> Loading...
  </h4>
  <div ng-hide="loading">

    <h3>Add Activity</h3>
    <form ng-submit="addLog(newLog, userId)" ng-show="userId" class="clearfix">

      <div class="row-fluid">
        <div class="col-md-9 col-sm-9">
          <input type="text" name="message" ng-model="newLog.message" 
          placeholder="type log message here..." class="form-control" />
        </div>
        <div class="col-md-3 col-sm-3">
          <a href class="btn btn-info" ng-click="ctrl.showMore = !ctrl.showMore"><i class="fa fa-cog"></i></a>
          <button class="btn btn-primary" ng-disabled="ctrl.submittingForm">
            <span ng-hide="ctrl.submittingForm">
              <i class="fa fa-plus"></i> Add
            </span>
            <span ng-show="ctrl.submittingForm">
              <i class="fa fa-spinner fa-spin"></i> ....
            </span>
          </button>
        </div>
      </div>
      
      <div class="row-fluid form-horizontal" ng-show="ctrl.showMore" nv-file-drop uploader="uploader">

        <div class="col-xs-12">
          <br />
          <div class="form-group">
            <label class="col-xs-1 control-label">Date/Time:</label>
            <div class="col-md-2">
              <input class="form-control" type="date" ng-model="newLog.createdAt">
            </div>
            <div class="col-md-2">
              <input class="form-control" type="time" ng-model="newLog.createdTime">
            </div>
          </div>
        </div>
        <div class="col-xs-12">
          <h4>Attachments</h4>
          <div ng-hide="uploader.isHTML5">HTML5 File Upload not supported by your browser.</div>
          <div ng-show="uploader.isHTML5">
            <div class="well file-drop-zone" nv-file-over uploader="uploader">
              Drop files here.
            </div>

            <h4>Upload queue</h4>
            <p>Queue length: {{ uploader.queue.length }}</p>

            <table class="table">
              <thead>
                <tr>
                  <th width="50%">Name</th>
                  <th ng-show="uploader.isHTML5">Size</th>
                  <th ng-show="uploader.isHTML5">Progress</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="item in uploader.queue">
                  <td><strong>{{ item.file.name }}</strong></td>
                  <td ng-show="uploader.isHTML5" nowrap>{{ item.file.size/1024/1024|number:2 }} MB</td>
                  <td ng-show="uploader.isHTML5">
                    <div class="progress" style="margin-bottom: 0;">
                        <div class="progress-bar" role="progressbar" ng-style="{ 'width': item.progress + '%' }"></div>
                    </div>
                  </td>
                  <td class="text-center">
                    <span ng-show="item.isSuccess"><i class="fa fa-ok"></i></span>
                    <span ng-show="item.isCancel"><i class="fa fa-ban-circle"></i></span>
                    <span ng-show="item.isError"><i class="fa fa-remove"></i></span>
                  </td>
                  <td nowrap>
                    <button ng-show="false" type="button" class="btn btn-success btn-xs" ng-click="item.upload()" ng-disabled="item.isReady || item.isUploading || item.isSuccess">
                        <span class="fa fa-upload"></span> Upload
                    </button>
                    <button type="button" class="btn btn-warning btn-xs" ng-click="item.cancel()" ng-disabled="!item.isUploading">
                        <span class="fa fa-ban-circle"></span> Cancel
                    </button>
                    <button type="button" class="btn btn-danger btn-xs" ng-click="item.remove()">
                        <span class="fa fa-trash"></span> Remove
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>

            <div>
              <div>
                Queue progress:
                <div class="progress" style="">
                  <div class="progress-bar" role="progressbar" ng-style="{ 'width': uploader.progress + '%' }"></div>
                </div>
              </div>
              <button ng-show="false" type="button" class="btn btn-success btn-s" 
                      ng-click="uploader.uploadAll()" 
                      ng-disabled="!uploader.getNotUploadedItems().length">
                  <span class="fa fa-upload"></span> Upload all
              </button>
              <button type="button" class="btn btn-warning btn-s" 
                      ng-click="uploader.cancelAll()" 
                      ng-disabled="!uploader.isUploading">
                  <span class="fa fa-ban-circle"></span> Cancel all
              </button>
              <button type="button" class="btn btn-danger btn-s"
                      ng-click="uploader.clearQueue()" 
                      ng-disabled="!uploader.queue.length">
                  <span class="fa fa-trash"></span> Remove all
              </button>
            </div>
          </div>

        </div>
      </div>
    </form>


    <h3>Activity Feed</h3>
    <p ng-hide="logs.length">
      There is no activity to display.
    </p>
    
      <table class="table" ng-show="logs.length">
        <thead>
          <tr>
            <th ng-hide="false && userId" width="150">User</th>
            <th>Activity</th>
            <th width="200">Created</th>
            <th width="50" class="text-center">
              <i class="fa fa-trash-o"></i>
            </th>
            <th width="50" class="text-center">
              <i class="fa fa-comments"></i>
            </th>
            <th width="50" class="text-center">
              <i class="fa fa-paperclip"></i>
            </th>
          </tr>
        </thead>
        <tbody ng-repeat="l in logs |orderBy:'-createdAt'">
          <tr ng-class="{active : l._id == selectedLog,warning:l.showAttachments||l.showReplies}">
            <td ng-hide="false && userId"><a ui-sref="users.user.activity({id:l.user._id})">{{l.user.name}}</a></td>
            <td><a href
                      editable-text="l.message"
                      onbeforesave="beforeSaveLogMessage($data, l._id)"
                      e-required
                      >{{l.message}}</a></td>
            <td>{{l.createdAt | date:'MMM d, yyyy @ h:mm a'}}</td>
            <td class="text-center"><a href ng-click="deleteLog(l)">
              <i class="fa fa-trash-o"></i>
            </a></td>
            <td class="text-center">
              <a href="" ng-click="toggleReplies(l)" 
                 ng-class="{disabled:!l.replies || !l.replies.length}">
                  <i class="fa" ng-class="{'fa-comment-o':!l.replies || !l.replies.length,'fa-comment':l.replies && l.replies.length}"></i>
              </a>
            </td><td class="text-center">
              <a href="" ng-click="toggleAttachments(l)" 
                 ng-class="{disabled:!l.attachments || !l.attachments.length}">
                  <i class="fa fa-paperclip"></i>
              </a>
            </td>
          </tr>


          <tr ng-show="l.showReplies" class="warning">
            <td colspan="6">
              <div class="panel panel-default">
                <div class="panel-heading"><h3 class="panel-title">Replies for {{l.message}}</h3></div>
                <div class="panel-body" ng-init="l.newMessage = {log:l._id,user:user._id}">
                  <form ng-submit="submitReply(l, l.newMessage)" role="form">
                    <textarea class="form-control" ng-model="l.newMessage.message"></textarea>
                    <button type="submit" class="btn btn-primary">Send</button>
                  </form>

                  <div class="reply" ng-repeat="r in l.replies|orderBy:'-createdAt'">
                    <p>{{r.message}}</p>
                    <span>by {{r.user.name}} on {{r.createdAt | date:'MMM d, yyyy @ h:mm a'}}</span>
                  </div>
                </div>
              </div>
            </td>
          </tr>


          <tr ng-show="l.showAttachments" class="warning">
            <td colspan="6">
              <div ng-hide="l.attachmentsLoaded"><i class="fa fa-spinner fa-spin"></i></div>
              <div ng-show="l.attachmentsLoaded" class="panel panel-default">
                <div class="panel-heading"><h3 class="panel-title">Attachments for {{l.message}}</h3></div>
                <div class="panel-body">
                  <table class="table" ng-show="l.attachments && l.attachments.length">
                    <thead><tr>
                      <th>Name</th>
                      <th>Filename</th>
                      <th colspan="3" class="text-center" width="100">Actions</th>
                    </tr></thead>
                    <tbody><tr ng-repeat="a in l.attachments" ng-class="{deletingAttachment:deletingAttachment==a._id}">
                      <td><a href
                        editable-text="a.name"
                        onbeforesave="beforeSaveAttachmentName($data, a._id)"
                        e-required
                        >{{a.name}}</a>
                      </td>
                      <td>{{a.filename}}</td>
                      <td class="text-center">
                        <a ng-show="a.type=='Image'" ng-click="showAttachmentImage(a, l)" href="">
                          <i class="fa fa-picture"></i>
                        </a>
                      </td><td class="text-center">
                        <a href="/api/attachments/{{a._id}}/download" target="_blank">
                          <i class="fa fa-download"></i>
                        </a>
                      </td><td class="text-center">
                        <a ng-click="deleteAttachment(a, l)" href="">
                          <i class="fa fa-trash-o"></i>
                        </a>
                      </td>
                    </tr></tbody>
                  </table>
                  <div nv-file-drop uploader="instaUploader" options="{url:'/api/logs/{{l._id}}/upload'}">
                    <div class="well file-drop-zone" nv-file-over uploader="instaUploader" >
                      <div ng-hide="instaUploader.uploading">Drop files here.</div>
                      <div ng-show="instaUploader.uploading" class="progress">
                        <div class="progress-bar" role="progressbar" ng-style="{ 'width': uploader.progress + '%' }"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
             
            </td>
          </tr>
        </tbody>
      </table>

    <paginateit
      collection="logs"
      url="filter.apiURL"
      per-page="filter.perPage"
      auto-presets="false"
      per-page-presets="[10,20,50,100]"
      template-url="/assets/paginate-anything.html">
    </paginateit>
  </div>
</div>
